---
categories: python, alembic, sqlalchemy, migrate, sql, database
...

数据库迁移工具 alembic (蒸馏器) 使用指南。

## 重点步骤

```
    pip install alembic # 安装，见配置alembic.ini、配置model、配置env.py
    alembic init alembic # 初始化
    alembic revision --autogenerate -m "本次改动内容" #自动跟踪
    alembic upgrade head # 升级
```

## 概念

数据库迁移(migration)提供了数据库schema变迁记录的版本控制. 在一个orm构架下，我们使用数据库以外的基于编程语言上的脚本来控制数据库结构。通常在面向对象的世界里，数据表以类的方式声明（models).

这意味着可以编写数据库结构变更脚本，在对象层面来操作数据库结构。

在alembic下你可以使用手工编写变更脚本，或者自动跟踪生成变更脚本两种方式来得到变更脚本。类似于代码版本控制，alembic可以让你管理每次的变更细节，回溯更改。

## 安装

在项目环境中,执行

```
    pip install alembic
```

### 配置alembic.ini

更改alembic.ini文件. 其中一行

```
    sqlalchemy.url = dialect+driver://user:pass@localhost/dbname
    # sqlalchemy.url = mysql+pymysql://user:pass@localhost/dbname
```

这行是sqlalchemy标准的数据引擎描述串。如果你的项目使用了ini文件来定义数据库连接事项，可以拷贝相应行过来。

## 初始化

从终端进入你的项目文件夹，运行

```
albembic init alembic
```

### 配置model

* 在你的项目文件中，找到含有
    `Base.metadata.create_all(engine)`的文件. 对这个文件进行修改。 头部加入:

```
    from alembic.config import Config
    from alembic import command
```

在
`Base.metadata.create_all(engine)`行后面插入:

```
    alembic_cfg=Config(alembic_uri)
    command.stamp(alembic_cfg, "head")
```

`alembic_uri` 为alembic.ini文件的路径.

再次运行初始化部分，如果有数据库存在最好删掉让它重建。此时alembic将把当前数据库结构状态作为初始状态。并跟踪此后的任何结构性变动。

## 自动生成变更脚本

### 配置env.py

修改alembic目录下的env.py文件, 找到`target_metadata`部分， 修改成：

```
from models import Base
target_metadata = Base.metadata
```

注意
`from&nbsp;models&nbsp;import&nbsp;Base`要根据你的项目文件做相应改动.

接下来，你可以到你的model文件去修改model定义了.

在某次定义修改完成后，我们需要让alembic自动找出修改的地方并生成修改脚本，执行以下命令:

```
alembic revision --autogenerate -m "Added new in the model"
```

-m 参数为你要写入的本次变化的说明.

我们可能得到类似于以下的输出：

```
    INFO  [alembic.migration] Context impl SQLiteImpl.
    INFO  [alembic.migration] Will assume non-transactional DDL.
    INFO  [alembic.autogenerate.compare] Detected added column 'models.new'
      Generating /home/geohuz/pym_salayout_study/dbl/alembic/versions/110d86bf5fbd_added_new_in_the_model.py ... done
```

如果检查它生成的脚本文件，你可以看到以下内容，你可以修改这个文件以达到你的特定要求：

```
    """Added new in the model
    Revision ID: 110d86bf5fbd
    Revises: None
    Create Date: 2014-01-09 13:32:15.358241

    """

    # revision identifiers, used by Alembic.
    revision = '110d86bf5fbd'
    down_revision = None

    from alembic import op
    import sqlalchemy as sa

    def upgrade():
        ### commands auto generated by Alembic - please adjust! ###
        op.add_column('models', sa.Column('new', sa.Integer(), nullable=True))
        ### end Alembic commands ###

    def downgrade():
        ### commands auto generated by Alembic - please adjust! ###
        op.drop_column('models', 'new')
        ### end Alembic commands ###
```

注意上面并没有实际变更数据库，执行命令

```
    alembic upgrade head

    INFO  [alembic.migration] Context impl SQLiteImpl.
    INFO  [alembic.migration] Will assume non-transactional DDL.
    INFO  [alembic.migration] Running upgrade None -> 110d86bf5fbd, Added new in the model
```

将实际变更物理数据库.

查看一下变更历史:

```
    alembic history

    Rev: 110d86bf5fbd (head)
    Parent: None
    Path: alembic/versions/110d86bf5fbd_added_new_in_the_model.py

        Added new in the model

        Revision ID: 110d86bf5fbd
        Revises: None
        Create Date: 2014-01-09 13:32:15.358241
```

### alembic自动生成脚本的限制

* Autogenerate 默认可以跟踪:
    * 表的增加和删除.
    * 列的增加和删除.
    * 改变表列的可为null状态.
    * 基础的索引变化和显式命名的唯一规则（unique constraints).
* Autogenerate 可选的跟踪项目:
    * 列数据类型变化。（需要在env.py 里的context.configure中增加：compare_type=True）
    * 服务器默认值表达式变化. （需要在env.py 里的context.configure中增加：compare_server_default=True）
* Autogenerate 不可以跟踪:
    * 表名变化.
    * 列名变化.
    * 匿名规则. 你应该给你的规则起名比如 [?](/UniqueConstraint)UniqueConstraint('col1', 'col2', name="my_name")
* Autogenerate 现在不可以，但最终会实现的跟踪特性:
    * Some free-standing constraint additions and removals, like CHECK and FOREIGN KEY - these are not fully implemented.
    * Sequence additions, removals - not yet implemented.

## 手动变更脚本维护

首先需要执行alembic告诉它我们要做数据库结构变动，

```
    $ alembic revision -m "create account table"
    Generating /path/to/yourproject/alembic/versions/1975ea83b712_create_account_table.py...done
```

我们看到一个新的变更脚本建立了: 1975ea83b712_create_account_table.py, 看看文件内容

```
    """create account table
    Revision ID: 1975ea83b712
    Revises: None
    Create Date: 2011-11-08 11:40:27.089406

    """

    # revision identifiers, used by Alembic.
    revision = '1975ea83b712'
    down_revision = None

    from alembic import op
    import sqlalchemy as sa

    def upgrade():
        pass

    def downgrade():
        pass
```

这是个模板文件，你需要完善的是upgrade和downgrade内部的具体代码。做完后执行

```
    alembic upgrade head
```

就完成了.

## Alembic 官方文档地址

详细信息参考: http://alembic.readthedocs.org/en/latest/tutorial.html